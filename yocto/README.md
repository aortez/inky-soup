# Inky Soup Yocto Build System

Yocto-based build system for Raspberry Pi Zero 2 W images with NetworkManager, SSH, and e-ink display support.

## Quick Start

```bash
cd yocto
npm install          # First time only
npm run build        # Build image (~20 min with sstate cache)
npm run flash        # Flash to SD card (interactive)
```

## Architecture

This project uses [KAS](https://kas.readthedocs.io/) for reproducible Yocto builds. All configuration is in a single `kas-inky-soup.yml` file.

### Directory Structure

```
yocto/
├── kas-inky-soup.yml             # KAS configuration (repos, layers, local.conf)
├── meta-inky-soup/               # Our custom layer
│   ├── conf/layer.conf          # Layer metadata
│   ├── recipes-core/images/     # Image recipe
│   ├── recipes-connectivity/    # NetworkManager config
│   ├── recipes-support/         # Persistent data, hostname
│   └── wic/                     # Partition layouts (future A/B)
├── scripts/                      # Flash and deploy scripts
│   ├── flash.mjs                # Interactive SD card flasher
│   └── yolo-update.mjs          # A/B partition updater (future)
├── build/                        # Build output (generated by kas)
├── downloads/                    # Shared download cache
├── sstate-cache/                 # Shared state cache
└── package.json                  # npm build shortcuts
```

KAS clones upstream layers (poky, meta-raspberrypi, meta-openembedded) automatically on first build.

### meta-inky-soup Layer

Our custom layer contains:

- **recipes-core/images/inky-soup-image.bb** - Main image recipe.
- **recipes-connectivity/networkmanager/** - NetworkManager config (enables nmtui).
- **recipes-core/init-ifupdown/** - Minimal interfaces file (lets NM manage devices).
- **recipes-support/persistent-data/** - Persistent /data partition support.
- **wic/sdimage-inky-soup.wks** - A/B partition layout (future).

## Build Configuration

### Target Hardware

- **Machine**: `raspberrypi0-2w` (Raspberry Pi Zero 2 W)
- **Architecture**: ARMv7 (cortex-a7), compatible with Pi Zero 2 W
- **WiFi**: BCM43436 chip

### Image Format

- **Type**: `wic.gz` with `wic.bmap` for fast flashing
- **Root filesystem**: ext4

### Partition Layout

A/B partition scheme for safe OTA updates:

| Partition | Size    | Label    | Purpose                                    |
|-----------|---------|----------|--------------------------------------------|
| 1         | 150 MB  | boot     | Kernel, device tree, config.txt           |
| 2         | 800 MB  | rootfs_a | Primary system (active on first boot)     |
| 3         | 800 MB  | rootfs_b | Secondary system (for OTA updates)        |
| 4         | 100 MB  | data     | Persistent storage (WiFi creds, logs)     |

The data partition survives all updates. WiFi credentials configured via `nmcli`/`nmtui` are stored in `/data/NetworkManager/system-connections/` and bind-mounted into place on boot.

### Included Packages

**Networking:**
- NetworkManager (nmcli, nmtui)
- WiFi firmware (linux-firmware-rpidistro-bcm43436)
- SSH server (openssh-sshd, openssh-sftp-server)
- avahi-daemon (mDNS for `hostname.local` discovery)

**System:**
- systemd (init system, required for persistent-data services)
- persistent-data (bind mounts WiFi credentials from /data, from pi-base)
- hostname-setup (sets hostname from /boot/hostname.txt, from pi-base)
- ab-boot-manager (A/B boot slot management, from pi-base)
- kbd (keyboard utilities)
- sudo (for administrative tasks)

**Security:**
- SSH key authentication (injected at flash time)
- User 'inky' (UID 1000) with passwordless sudo
- No password login (SSH key only)

## Development Workflow

### Building

```bash
# Build the image
npm run build

# Or directly with kas:
kas build kas-inky-soup.yml
```

Build output: `build/tmp/deploy/images/raspberrypi0-2w/`

### Flashing

```bash
# Interactive device selection
npm run flash

# Direct device specification
npm run flash -- --device /dev/sdb

# Dry run (show what would happen)
npm run flash -- --dry-run
```

**Flash script features:**
- Detects and lists available SD cards/USB drives
- SSH key injection (uses your ~/.ssh/*.pub key)
- WiFi credential injection (prompts for SSID/password)
- Hostname configuration
- Data partition backup/restore (preserves WiFi credentials across reflashes)
- Uses bmaptool if available

**First-time flash script setup:**

On first run, the script prompts you to select which SSH key to use. Your choice is saved in `.flash-config.json`.

To reconfigure: `npm run flash -- --reconfigure`

### Accessing the Device

**SSH** (after connecting to network):
```bash
ssh inky@inky-soup.local
```

Your SSH key was injected during flash, so no password needed. The `inky` user has passwordless sudo for administrative tasks.

## Network Configuration

### WiFi Setup at Flash Time (Recommended)

**Option 1: Credentials file (recommended for repeated flashing)**

Create `wifi-creds.local` in the yocto directory:

```json
{
  "ssid": "MyNetworkName",
  "password": "MySecretPassword"
}
```

The flash script will automatically use these credentials. This file is gitignored.

**Option 2: Interactive prompt**

If no credentials file exists, the script prompts during flash:

```
WiFi Configuration

ℹ Configure WiFi now so the device can connect on first boot.
ℹ Press Enter to skip (you can configure later with nmtui).

WiFi network name (SSID): MyNetwork
WiFi password: ********
```

The credentials are written to the data partition and automatically used on boot.

### Manual WiFi Setup (Alternative)

If you skipped WiFi during flash, or need to connect to a different network:

```bash
# Login via serial console or HDMI
# Username: root, Password: (empty)

nmtui
# Select "Activate a connection"
# Choose your WiFi network
# Enter password
```

Credentials are stored in `/data/NetworkManager/system-connections/` and persist across reflashes.

### Credential Persistence

The `/data` partition is preserved during both:
- Full reflashes (the flash script backs up and restores)
- A/B updates (the partition is never touched)

This means WiFi credentials configured once will survive all updates.

## Package Management

This image uses **dnf** (RPM-based package manager).

**Common commands:**
```bash
# Update package list
dnf check-update

# Install package
dnf install <package>

# Search for packages
dnf search <keyword>
```

**Note**: Yocto images are typically immutable - package installation is for debugging only. Permanent changes should be added to the image recipe.

## Customization

### Adding Packages to Image

Edit `meta-inky-soup/recipes-core/images/inky-soup-image.bb`:

```bitbake
IMAGE_INSTALL:append = " \
    your-package-name \
"
```

Then rebuild: `npm run build`

### Modifying Build Configuration

Edit `kas-inky-soup.yml` in the `local_conf_header` section:

```yaml
local_conf_header:
  base: |
    # Your configuration here
    IMAGE_FSTYPES = "wic.gz wic.bmap"
```

### Adding a Custom Recipe

Create `meta-inky-soup/recipes-<category>/<package>/<package>.bb`:

```bitbake
SUMMARY = "Your package"
LICENSE = "MIT"

SRC_URI = "file://your-source.tar.gz"

do_install() {
    install -d ${D}${bindir}
    install -m 0755 your-binary ${D}${bindir}/
}
```

## Troubleshooting

### Build Fails with "Nothing RPROVIDES"

Package name is wrong. Find the correct name:

```bash
kas shell kas-inky-soup.yml -c "bitbake-layers show-recipes | grep <keyword>"
```

### "Layer depends on layer X but it's not enabled"

Check layer dependencies in `meta-inky-soup/conf/layer.conf` and ensure required layers are in `kas-inky-soup.yml`.

### Image Too Large

Check what's taking space:

```bash
kas shell kas-inky-soup.yml -c "bitbake -e inky-soup-image | grep ^IMAGE_INSTALL="
```

### NetworkManager Shows Devices as "unmanaged"

Check `/etc/network/interfaces` - if eth0/wlan0 are defined there, NM won't touch them.

Our bbappend should fix this, but if not:
```bash
# Temporarily fix on device
echo "auto lo
iface lo inet loopback" > /etc/network/interfaces
killall NetworkManager && NetworkManager &
```

### Build Cache Issues

```bash
# Clean specific recipe
kas shell kas-inky-soup.yml -c "bitbake -c cleansstate <recipe-name>"

# Clean everything (nuclear option)
rm -rf build/tmp build/cache
```

## Performance Notes

### Shared Caches

The `downloads/` and `sstate-cache/` directories are shared across builds and can grow large:

- **downloads/**: Source tarballs and git repos (~10-50 GB)
- **sstate-cache/**: Pre-built objects (~20-100 GB)

These are safe to delete if disk space is tight, but rebuilds will be slower.

### Build Parallelism

Configured in `kas-inky-soup.yml`:

```yaml
local_conf_header:
  base: |
    BB_NUMBER_THREADS = "8"      # Parallel bitbake tasks
    PARALLEL_MAKE = "-j 8"       # Parallel make jobs per recipe
```

Adjust based on your CPU cores and RAM.

## Shared Infrastructure

This project uses [sparkle-duck-shared](https://github.com/aortez/sparkle-duck-shared) (pi-base) for common Yocto infrastructure. The pi-base layer provides:
- A/B partition layout for safe OTA updates
- Persistent data partition management
- Hostname setup from `/boot/hostname.txt`
- Flash script utilities (JavaScript library)

## TODO

### Completed
- [x] A/B partition support for atomic updates
- [x] Hostname advertising (avahi/mDNS) - `<hostname>.local`
- [x] Inky-soup server package and service
- [x] Integrate sparkle-duck-shared (pi-base)
- [x] Migrate to KAS-based build system
- [x] Persistent `/data` partition for WiFi credentials across updates
- [x] Python display script integration
- [x] WiFi credential injection at flash time

### Next
- [ ] A/B update script (yolo-update.mjs) for OTA updates
- [ ] Pre-dithered image pipeline
- [ ] Test on actual Pi Zero 2 W with e-ink display

## References

- [Yocto Project Documentation](https://docs.yoctoproject.org/)
- [KAS Documentation](https://kas.readthedocs.io/)
- [meta-raspberrypi Layer](https://github.com/agherzan/meta-raspberrypi)
- [NetworkManager Documentation](https://networkmanager.dev/)
