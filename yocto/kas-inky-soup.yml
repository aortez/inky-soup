# KAS configuration for Inky Soup Yocto build
# E-ink display system for Raspberry Pi Zero W / Zero 2 W
#
# Usage:
#   kas build kas-inky-soup.yml

header:
  version: 14

distro: poky

# Unified machine supporting both Pi Zero W and Pi Zero 2 W.
# Uses ARMv6 for compatibility with both boards.
machine: raspberrypi-inky-soup

repos:
  # Core Yocto - the foundation.
  poky:
    url: "https://git.yoctoproject.org/poky"
    branch: scarthgap
    layers:
      meta:
      meta-poky:

  # Raspberry Pi BSP.
  meta-raspberrypi:
    url: "https://git.yoctoproject.org/meta-raspberrypi"
    branch: scarthgap

  # OpenEmbedded layers for NetworkManager and other goodies.
  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    branch: scarthgap
    layers:
      meta-networking:
      meta-oe:
      meta-python:

  # Rust/Cargo support for building the server.
  meta-rust:
    url: "https://github.com/meta-rust/meta-rust.git"
    branch: scarthgap

  # Our custom layer for Inky Soup.
  meta-inky-soup:
    path: meta-inky-soup

local_conf_header:
  # Machine and build configuration.
  base: |
    # Accept restricted licenses (Pi WiFi firmware).
    LICENSE_FLAGS_ACCEPTED = "commercial synaptics-killswitch"

    # Rust version for meta-rust layer.
    # 1.86.0 is needed for current crate ecosystem (tera, pest, time, etc.).
    RUST_VERSION = "1.86.0"
    PREFERRED_VERSION_rust = "${RUST_VERSION}"
    PREFERRED_VERSION_rust-native = "${RUST_VERSION}"
    PREFERRED_VERSION_rust-llvm = "${RUST_VERSION}"
    PREFERRED_VERSION_rust-llvm-native = "${RUST_VERSION}"
    PREFERRED_VERSION_cargo = "${RUST_VERSION}"
    PREFERRED_VERSION_cargo-native = "${RUST_VERSION}"
    PREFERRED_VERSION_libstd-rs = "${RUST_VERSION}"

    # Use systemd as init system.
    INIT_MANAGER = "systemd"

    # Set hostname (can be overridden by /boot/hostname.txt at boot).
    hostname:pn-base-files = "inky-soup"

    # Use wic for SD card image with A/B partitions.
    IMAGE_FSTYPES = "wic.gz wic.bmap"
    WKS_FILE = "sdimage-ab.wks"

    # Faster builds - adjust to your CPU cores.
    BB_NUMBER_THREADS = "8"
    PARALLEL_MAKE = "-j 8"

    # Download directory (shared across builds).
    DL_DIR = "${TOPDIR}/../downloads"

    # Shared state cache (speeds up rebuilds).
    SSTATE_DIR = "${TOPDIR}/../sstate-cache"

    # Disable SPDX generation (requires user namespaces which may not be available).
    INHERIT:remove = "create-spdx"

  # Raspberry Pi specific configuration.
  rpi: |
    # Disable rainbow splash for cleaner boot.
    DISABLE_SPLASH = "1"

    # Boot from SD card (A/B partitions on mmcblk0).
    # Partition 2 = rootfs_a, Partition 3 = rootfs_b.
    CMDLINE_ROOT_PARTITION = "/dev/mmcblk0p2"

  # Hardware configuration for Inky Impression e-ink display.
  display: |
    # Enable SPI bus for e-ink display communication.
    # The Inky Impression uses SPI0 with manual chip select via GPIO.
    ENABLE_SPI_BUS = "1"

    # Enable I2C for display EEPROM (used to detect display model).
    ENABLE_I2C = "1"

    # Extra config.txt settings (SPI, I2C, HDMI debug, minimal GPU).
    RPI_EXTRA_CONFIG = "\ndtparam=spi=on\ndtparam=i2c_arm=on\nhdmi_force_hotplug=1\nhdmi_group=2\nhdmi_mode=87\nhdmi_cvt=640 480 60 1 0 0 0\ngpu_mem=16\n"

# Target image to build - our custom image recipe.
target: inky-soup-image
