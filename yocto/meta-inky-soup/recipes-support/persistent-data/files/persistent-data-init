#!/bin/sh
# Initialize persistent data partition structure.
# This runs on every boot but only creates directories if missing.

set -e

DATA_DIR="/data"
NM_PERSISTENT="$DATA_DIR/NetworkManager/system-connections"
NM_SYSTEM="/etc/NetworkManager/system-connections"

# Ensure base directories exist.
mkdir -p "$DATA_DIR/NetworkManager/system-connections"
mkdir -p "$DATA_DIR/logs"
mkdir -p "$DATA_DIR/config"

# Set proper ownership for NetworkManager directory.
# NetworkManager runs as root and needs these permissions.
chmod 755 "$DATA_DIR/NetworkManager"
chmod 700 "$DATA_DIR/NetworkManager/system-connections"

# If there are connections in the rootfs that aren't in /data, copy them.
# This handles first boot after a fresh flash.
if [ -d "$NM_SYSTEM" ]; then
    for conn in "$NM_SYSTEM"/*; do
        if [ -f "$conn" ]; then
            name=$(basename "$conn")
            if [ ! -f "$NM_PERSISTENT/$name" ]; then
                cp -p "$conn" "$NM_PERSISTENT/$name"
                echo "Copied $name to persistent storage"
            fi
        fi
    done
fi

echo "Persistent data initialized"
