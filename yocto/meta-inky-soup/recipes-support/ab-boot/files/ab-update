#!/bin/sh
# A/B Update Helper
# Flashes rootfs to inactive partition and switches boot.
# NOTE: The /data partition (partition 4) is preserved across updates.
# WiFi credentials and other persistent config stored there will survive.

set -e

IMAGE_PATH="$1"

if [ -z "$IMAGE_PATH" ]; then
    echo "usage: $0 <rootfs-image.ext4.gz>" >&2
    exit 1
fi

if [ ! -f "$IMAGE_PATH" ]; then
    echo "error: $IMAGE_PATH not found" >&2
    exit 1
fi

# Get inactive partition
INACTIVE_SLOT=$(ab-boot-manager inactive)
INACTIVE_DEV=$(ab-boot-manager inactive-device)

echo "=== A/B Update ==="
echo "Inactive slot: $INACTIVE_SLOT"
echo "Target device: $INACTIVE_DEV"
echo "Image: $IMAGE_PATH"
echo ""

# Flash to inactive partition
echo "Flashing rootfs to $INACTIVE_DEV..."
sudo sh -c "gunzip -c '$IMAGE_PATH' | dd of='$INACTIVE_DEV' bs=4M"
sync

echo "Verifying filesystem..."
sudo e2fsck -f -y "$INACTIVE_DEV" || true

echo "Switching boot slot to $INACTIVE_SLOT..."
sudo ab-boot-manager switch "$INACTIVE_SLOT"

echo ""
echo "=== Update Complete ==="
echo "Next boot will use slot $INACTIVE_SLOT"
echo "Reboot now to activate the new image."
