#!/bin/sh
# A/B Boot Slot Manager
# Manages which rootfs partition to boot from

BOOT_FLAG="/boot/boot_slot"
CMDLINE="/boot/cmdline.txt"

# Get current active slot from where we're running
get_current_slot() {
    # Get root device from kernel cmdline (more reliable than /proc/mounts)
    root_device=$(cat /proc/cmdline | grep -o 'root=[^ ]*' | cut -d= -f2)
    case "$root_device" in
        *2|*p2) echo "a" ;;
        *3|*p3) echo "b" ;;
        *) echo "unknown" ;;
    esac
}

# Get inactive slot (the one to update)
get_inactive_slot() {
    current=$(get_current_slot)
    if [ "$current" = "a" ]; then
        echo "b"
    elif [ "$current" = "b" ]; then
        echo "a"
    else
        echo "error: unknown current slot" >&2
        return 1
    fi
}

# Get device path for a slot
get_slot_device() {
    slot="$1"

    # Get current root device from cmdline and derive the base device name
    root_device=$(cat /proc/cmdline | grep -o 'root=[^ ]*' | cut -d= -f2)
    base_device=$(echo "$root_device" | sed 's/[0-9]*$//')

    case "$slot" in
        a) echo "${base_device}2" ;;
        b) echo "${base_device}3" ;;
        *) echo "error: invalid slot $slot" >&2; return 1 ;;
    esac
}

# Switch boot to specified slot
switch_boot_slot() {
    new_slot="$1"
    device=$(get_slot_device "$new_slot")

    # Update cmdline.txt to boot from new slot
    if [ -f "$CMDLINE" ]; then
        # Replace root= parameter (handle both sda2/sda3 and mmcblk0p2/mmcblk0p3 patterns)
        sed -i "s|root=/dev/[^[:space:]]*|root=${device}|" "$CMDLINE"

        # Write slot marker
        echo "$new_slot" > "$BOOT_FLAG"

        echo "Boot slot switched to $new_slot ($device)"
        return 0
    else
        echo "error: $CMDLINE not found" >&2
        return 1
    fi
}

# Get data partition device.
get_data_device() {
    root_device=$(cat /proc/cmdline | grep -o 'root=[^ ]*' | cut -d= -f2)
    base_device=$(echo "$root_device" | sed 's/[0-9]*$//')
    echo "${base_device}4"
}

# Show status.
show_status() {
    current=$(get_current_slot)
    inactive=$(get_inactive_slot)
    current_dev=$(get_slot_device "$current")
    inactive_dev=$(get_slot_device "$inactive")
    data_dev=$(get_data_device)

    echo "Current slot:  $current ($current_dev)"
    echo "Inactive slot: $inactive ($inactive_dev)"
    echo "Data partition: $data_dev (persistent)"

    if [ -f "$BOOT_FLAG" ]; then
        flag=$(cat "$BOOT_FLAG")
        echo "Boot flag:     $flag"
    fi

    # Show data mount status.
    if mountpoint -q /data 2>/dev/null; then
        echo "Data mount:    mounted"
    else
        echo "Data mount:    not mounted"
    fi
}

# Main command dispatcher
case "$1" in
    current)
        get_current_slot
        ;;
    inactive)
        get_inactive_slot
        ;;
    inactive-device)
        slot=$(get_inactive_slot) && get_slot_device "$slot"
        ;;
    switch)
        if [ -z "$2" ]; then
            echo "usage: $0 switch {a|b}" >&2
            exit 1
        fi
        switch_boot_slot "$2"
        ;;
    status)
        show_status
        ;;
    *)
        echo "usage: $0 {current|inactive|inactive-device|switch|status} [slot]" >&2
        exit 1
        ;;
esac
