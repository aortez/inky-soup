#@TYPE: Machine
#@NAME: Inky Soup Unified Raspberry Pi (Zero W + Zero 2 W)
#@DESCRIPTION: Unified machine configuration for Inky Soup supporting both
#              Raspberry Pi Zero W (ARMv6) and Raspberry Pi Zero 2 W (ARMv8).
#              Builds for ARMv6 to ensure compatibility with both boards.

# Inherit raspberrypi0-wifi overrides so the kernel BSP metadata is found.
MACHINEOVERRIDES =. "raspberrypi0-wifi:"

# Use ARM1176JZF-S tuning with hard-float (ARMv6 + VFPv2).
# The Pi Zero W has VFP hardware, so we can use hard-float ABI.
# Zero 2 W can run ARMv6 code natively, though not at full speed.
# Note: Use meta-raspberrypi's tune file, not the generic poky one.
DEFAULTTUNE ?= "arm1176jzfshf"
require conf/machine/include/tune-arm1176jzf-s.inc
include conf/machine/include/rpi-base.inc

# WiFi and Bluetooth firmware for both Zero W and Zero 2 W.
# Zero W uses BCM43430A1, Zero 2 W uses BCM43436.
MACHINE_EXTRA_RRECOMMENDS += "\
    linux-firmware-rpidistro-bcm43430 \
    bluez-firmware-rpidistro-bcm43430a1-hcd \
    linux-firmware-rpidistro-bcm43436 \
    linux-firmware-rpidistro-bcm43436s \
"

# Device trees for both Zero W and Zero 2 W.
# Note: Path includes broadcom/ subdirectory for kernel 6.x+.
RPI_KERNEL_DEVICETREE = " \
    broadcom/bcm2708-rpi-zero-w.dtb \
    broadcom/bcm2710-rpi-zero-2-w.dtb \
"

# Include overlays for SPI (Inky Impression uses SPI).
RPI_KERNEL_DEVICETREE_OVERLAYS:append = " \
    overlays/spi0-0cs.dtbo \
"

# Serial console for debugging.
SERIAL_CONSOLES = "115200;ttyAMA0"

# Kernel image naming.
# Zero W loads kernel.img, Zero 2 W can use kernel7l.img or kernel.img.
# We'll use kernel.img (ARMv6) for both.
SDIMG_KERNELIMAGE ?= "kernel.img"

# 32-bit kernel settings.
KERNEL_IMAGETYPE = "zImage"

# GPU memory (minimal - e-ink doesn't need GPU).
GPU_MEM = "16"

# Enable hardware features.
ENABLE_SPI_BUS = "1"
ENABLE_I2C = "1"
ENABLE_UART = "1"

# Disable features we don't need.
DISABLE_OVERSCAN = "1"

# The Zero doesn't have onboard audio we need.
MACHINE_FEATURES:remove = "alsa"
