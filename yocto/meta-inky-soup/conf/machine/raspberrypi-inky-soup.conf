#@TYPE: Machine
#@NAME: Inky Soup Unified Raspberry Pi (Zero W + Zero 2 W)
#@DESCRIPTION: Unified machine configuration for Inky Soup e-ink display project
#              supporting both Raspberry Pi Zero W and Zero 2 W.
#              Uses ARMv6 (hard-float) for binary compatibility across both boards.

# Inherit raspberrypi0-wifi overrides so BSP metadata is found.
MACHINEOVERRIDES =. "raspberrypi0-wifi:"

# Use ARM1176JZF-S tuning (ARMv6 with hard-float VFP).
# This runs natively on Zero W and in compatibility mode on Zero 2 W.
# Zero 2 W's Cortex-A53 handles ARMv6 code with minimal overhead.
DEFAULTTUNE = "arm1176jzfshf"
require conf/machine/include/tune-arm1176jzf-s.inc
include conf/machine/include/rpi-base.inc

# WiFi and Bluetooth firmware for both Zero W and Zero 2 W.
MACHINE_EXTRA_RRECOMMENDS += "\
    linux-firmware-rpidistro-bcm43430 \
    bluez-firmware-rpidistro-bcm43430a1-hcd \
    linux-firmware-rpidistro-bcm43436 \
    linux-firmware-rpidistro-bcm43436s \
    bluez-firmware-rpidistro-bcm43430b0-hcd \
"

# Device trees for both Zero W and Zero 2 W.
# The bootloader auto-selects based on detected hardware.
RPI_KERNEL_DEVICETREE = " \
    broadcom/bcm2708-rpi-zero-w.dtb \
    broadcom/bcm2710-rpi-zero-2-w.dtb \
"

# SPI overlay for Inky Impression e-ink display.
# The display uses SPI for data and GPIO for control signals.
RPI_KERNEL_DEVICETREE_OVERLAYS:append = " \
    overlays/spi0-0cs.dtbo \
"

# Serial console on GPIO pins (useful for debug without SSH).
SERIAL_CONSOLES = "115200;ttyS0"

# Kernel image for 32-bit ARM.
KERNEL_IMAGETYPE = "zImage"
SDIMG_KERNELIMAGE ?= "kernel.img"

# U-Boot configuration (not using U-Boot, direct kernel boot).
KERNEL_BOOTCMD ?= "bootz"

# ARM stub for early boot.
ARMSTUB ?= "armstub.bin"

# Machine features.
# - sdio: SD card and WiFi use SDIO bus.
# - wifi/bluetooth: Onboard wireless.
# - No pci (Zero doesn't have PCIe).
MACHINE_FEATURES += "sdio wifi bluetooth"
MACHINE_FEATURES:remove = "pci"

# Enable SPI and I2C in config.txt for Inky display.
# SPI: Main data bus for the e-ink controller.
# I2C: May be needed for display identification.
ENABLE_SPI_BUS = "1"
ENABLE_I2C = "1"

# GPU memory allocation (minimal - we don't need GPU for e-ink).
# Keep some for HDMI debug output.
GPU_MEM = "16"

# Enable HDMI output for debug console.
# This lets you plug in a monitor for troubleshooting.
HDMI_FORCE_HOTPLUG = "1"
